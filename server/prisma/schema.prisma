generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String          @id @default(cuid())
  email                 String?         @unique
  passwordHash          String?
  isAdmin               Boolean         @default(false)
  bannedAt              DateTime?
  bannedReason          String?
  isApproved            Boolean         @default(false)
  failedLoginAttempts   Int             @default(0)
  lockedUntil           DateTime?
  lastLoginAt           DateTime?
  tokenVersion          Int             @default(1)
  stravaClientIdEnc     String?
  stravaClientSecretEnc String?
  stravaRedirectUriEnc  String?
  stravaAthleteId       Int?            @unique
  hrMax                 Int             @default(190)
  age                   Int?
  weightKg              Float?
  heightCm              Float?
  goalType              String?
  goalDistanceKm        Float?
  goalTimeSec           Int?
  speedUnit             String          @default("kmh")
  distanceUnit          String          @default("km")
  elevationUnit         String          @default("m")
  cadenceUnit           String          @default("rpm")
  language              String          @default("fr")
  subscriptionTier      SubscriptionTier @default(FREE)
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  token                 StravaToken?
  activities            Activity[]
  chartSnapshots        ChartSnapshot[]
  trainingPlans         TrainingPlan[]
  securityEvents        SecurityEvent[]
  usageCounters         UsageCounter[]
}

model StravaToken {
  id                   String   @id @default(cuid())
  userId               String   @unique
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken          String
  refreshToken         String
  oauthClientIdEnc     String?
  oauthClientSecretEnc String?
  expiresAt            DateTime
  updatedAt            DateTime @updatedAt
}

model Activity {
  id                   String   @id @default(cuid())
  userId               String
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  stravaActivityId     String   @unique
  name                 String
  type                 String
  sportType            String
  startDate            DateTime
  startDateLocal       DateTime
  timezone             String
  distance             Float
  movingTime           Int
  elapsedTime          Int
  totalElevationGain   Float
  averageSpeed         Float
  maxSpeed             Float
  averageHeartrate     Float?
  maxHeartrate         Float?
  averageWatts         Float?
  maxWatts             Float?
  weightedAverageWatts Float?
  kilojoules           Float?
  calories             Float?
  averageCadence       Float?
  strideLength         Float?
  groundContactTime    Float?
  verticalOscillation  Float?
  sufferScore          Float?
  trainer              Boolean
  commute              Boolean
  manual               Boolean
  hasHeartrate         Boolean
  importedAt           DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([userId, startDate(sort: Desc)])
}

model ChartSnapshot {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  chartType  String
  filterHash String
  payload    Json
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([userId, chartType, filterHash])
  @@index([userId, chartType, updatedAt(sort: Desc)])
}

model TrainingPlan {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title       String
  goal        String
  weeks       Int
  startDate   DateTime
  raceDate    DateTime
  daysToRace  Int
  overview    String
  methodology String
  warnings    Json
  plan        Json
  sourceModel String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId, updatedAt(sort: Desc)])
}

model SecurityEvent {
  id        String   @id @default(cuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  eventType String
  success   Boolean
  ipHash    String?
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([userId, createdAt(sort: Desc)])
  @@index([eventType, createdAt(sort: Desc)])
}

enum SubscriptionTier {
  FREE
  SUPPORTER
}

enum UsageFeature {
  STRAVA_IMPORT
  AI_REQUEST
  TRAINING_PLAN
}

model UsageCounter {
  id          String       @id @default(cuid())
  userId      String
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  feature     UsageFeature
  bucketStart DateTime
  count       Int          @default(0)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@unique([userId, feature, bucketStart])
  @@index([userId, feature, bucketStart])
}
